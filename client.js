import {
    initializeApp
} from 'firebase/app';
import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged
} from 'firebase/auth';
import WebSocket from 'ws';
import {
    fetchViewData,
    fetchAllViewNames,
    fetchQueryData,
    fetchProducerData,
    fetchAllStoredProcedures
} from './dbManager.js';
import {
    firebaseConfig
} from './firebase_setting.js';

import dotenv from 'dotenv';
dotenv.config();

import fs from 'fs';
import path from 'path';
// ‡πÇ‡∏´‡∏•‡∏î list view ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
const viewsConfigPath = path.join(process.cwd(), 'viewsConfig.json');
let viewsConfig = [];


const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

let socket = null;
let isConnecting = false;
let isLoggedIn = false;
let isLoggingIn = false;
let client_id = null; // ‡πÄ‡∏Å‡πá‡∏ö UID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ


function keepAlive() {
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ action: "keep_alive" }));
        //console.log("[üîÑ] Sent Keep Alive message.");
    }
    setTimeout(keepAlive, 30000); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
}



function loadViewsConfig() {
    if (fs.existsSync(viewsConfigPath)) {
        try {
            viewsConfig = JSON.parse(fs.readFileSync(viewsConfigPath, 'utf8'));
            //console.log(`[üìÑ] Loaded ${viewsConfig.length} views from config`);
            //console.log(`[üîç] First View Config:`, JSON.stringify(viewsConfig[0], null, 2)); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
        } catch (err) {
            console.error(`[‚ùå] Error reading viewsConfig.json:`, err);
            viewsConfig = [];
        }
    } else {
        console.warn(`[‚ö†] viewsConfig.json not found!`);
    }
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î list view ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
loadViewsConfig();


// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î SQL query ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
function loadSQLQuery(viewConfig) {
    if (viewConfig.sqlfile) {
        const filePath = path.join(process.cwd(), viewConfig.sqlfile);
        if (fs.existsSync(filePath)) {
            try {
                const sqlContent = fs.readFileSync(filePath, 'utf8').trim(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ SQL ‡∏à‡∏£‡∏¥‡∏á
                console.log(`[‚úÖ] Loaded SQL from file: ${filePath}`);
                //console.log(`[üìù] SQL Content (First 100 chars): ${sqlContent.substring(0, 100)}...`); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SQL ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
                return sqlContent;
            } catch (err) {
                console.error(`[‚ùå] Error reading SQL file: ${filePath}`, err);
                return null;
            }
        } else {
            console.error(`[‚ùå] SQL file not found: ${filePath}`);
            return null;
        }
    }
    return viewConfig.sqlquery || null;
}

function generateParams(sql, params = []) {
    // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô "?" ‡πÉ‡∏ô SQL
    const placeholderCount = (sql.match(/\?/g) || []).length;

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤ params ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö placeholderCount
    const filledParams = Array.from({ length: placeholderCount }, (_, i) => params[i] ?? '');

    return filledParams;
}

async function connectWebSocket(token) {
    if (isConnecting) {
        console.log('[‚ö†] WebSocket is already connecting...');
        return;
    }
    isConnecting = true;

    if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        console.log('[‚ö†] WebSocket is already connected or connecting. Skipping new connection...');
        return;
    }

    console.log(`[üîó] Connecting to WebSocket with Token: ${token.substring(0, 20)}...`);
    socket = new WebSocket(`${process.env.ws_server}?token=${token}`);


    socket.onopen = async () => {
        console.log('[‚úÖ] WebSocket connected');
        keepAlive();
        for (const view of viewsConfig) {
            if (view.run_on_startup && !view.is_produce) {
                console.log(`[üîÑ] Running startup sync for view: ${view.viewname}`);

                let sqlQuery = loadSQLQuery(view);

                if (!sqlQuery) {
                    console.error(`[‚ùå] No valid SQL query found for ${view.viewname}`);
                    continue;
                }

                console.log(`[üìù] Executing SQL for view: ${view.viewname}`);
                //console.log(`[üìù] SQL Query Preview: ${sqlQuery.substring(0, 100)}...`); // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SQL ‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô

                try {
                    const data = await fetchQueryData(sqlQuery); // ‚úÖ ‡πÉ‡∏ä‡πâ SQL query ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå

                    socket.send(JSON.stringify({
                        action: 'update_data',
                        client_id: client_id,
                        view: view.viewname,
                        data
                    }));

                    console.log(`[üöÄ] Sent ${data.length} records from ${view.viewname} to server`);
                } catch (sqlError) {
                    console.error(`[‚ùå] SQL execution failed for ${view.viewname}: ${sqlError.message}`);
                }
            }
            else if ( view.run_on_startup && view.is_produce ) {
                console.log(`[üìù] Executing Produce for view: ${view.viewname}`);
                let params = ['',''];
                try {
                    params = generateParams(view.cmd,params)
                    const data = await fetchProducerData(view.cmd,params);
                    //console.log(data);
                    socket.send(JSON.stringify({
                        action: 'update_data',
                        client_id: client_id,
                        view: view.viewname,
                        data
                    }));

                    console.log(`[üöÄ] Sent ${data.length} records from ${view.viewname} to server`);
                } catch (sqlError) {
                    console.error(`[‚ùå] SQL execution failed for ${view.viewname}: ${sqlError.message}`);
                }
            }
        }

        const views = (await fetchAllViewNames()).filter(view => view !== 'user');
        socket.send(JSON.stringify({
            action: 'initial_views',
            client_id: client_id, // ‚úÖ ‡∏™‡πà‡∏á client_id ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Views
            views: views
        }));

        socket.send(JSON.stringify({
            action: 'sync_all'
        }));

        socket.send(JSON.stringify({
            action: 'register',
            client_id: client_id, // ‚úÖ ‡∏™‡πà‡∏á client_id ‡πÑ‡∏õ‡∏Å‡∏±‡∏ö Views
            views: views
        }));
    };


    socket.onmessage = async (message) => {
        const response = JSON.parse(message.data);
        //console.log("[üì•] Received WebSocket Request:", response);
        
        if (response.action === 'sync_view') {
            console.log(`[üîÑ] Syncing data for view: ${response.view}`);
            const allViewNames = await fetchAllViewNames();
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ view ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `viewsConfig` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const viewConfig = viewsConfig.find(v => v.viewname === response.view);

            // console.log("‚úÖ viewConfig:", viewConfig);
            //console.log("‚úÖ allViewNames:", allViewNames);
            //console.log("‚úÖ response.view:", response.view);
            // console.log("‚úÖ allViewNames.includes(response.view):", allViewNames.includes(response.view));


            let data;
            if (viewConfig && !allViewNames.includes(response.view)) {
                console.log(`[üìù] Found viewConfig for ${response.view}, using SQL query.`);
                if(viewConfig.is_produce)
                    {
                  data = await fetchProducerData(viewConfig.cmd,['','']);         
                    }
                    else
                    {
                        const sqlQuery = loadSQLQuery(viewConfig);
                        data = await fetchQueryData(sqlQuery); // ‚úÖ ‡πÉ‡∏ä‡πâ SQL query
                    }
                socket.send(JSON.stringify({
                    action: 'update_data',
                    client_id: client_id,
                    view: response.view,
                    data
                }));
            } else if (viewConfig === undefined && allViewNames.includes(response.view)) {
                console.log(`[üìù] Found Original View for ${response.view}`);
                data = await fetchViewData(response.view); // ‚úÖ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å View ‡∏õ‡∏Å‡∏ï‡∏¥
                // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
                socket.send(JSON.stringify({
                    action: 'update_data',
                    client_id: client_id,
                    view: response.view,
                    data
                }));
            } else {
                console.error(`[‚ùå] No viewSQLConfig and  DATABASE view name in : ${response.view}`);
            }
        }else if (response.action === 'sync_view_wait') {
            console.log(`[üîÑ] Syncing data for sync_view_wait: ${response.view}`);
            console.log(`[üîÑ] response.requestId : ${response.reqId}`);
            const allViewNames = await fetchAllViewNames();
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ view ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `viewsConfig` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const viewConfig = viewsConfig.find(v => v.viewname === response.view);

            let data;
            if (allViewNames.includes(response.view)) {
                console.log(`[üìù] Found Original View for ${response.view}`);
                data = await fetchViewData(response.view); // ‚úÖ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å View ‡∏õ‡∏Å‡∏ï‡∏¥
                // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
                socket.send(JSON.stringify({
                    action: 'update_data_sql',
                    client_id: client_id,
                    view: response.view,
                    data,
                    requestId: response.reqId, // ‚úÖ ‡πÉ‡∏™‡πà requestId ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
                }));

                //console.log("sync_view_wait sync_view_wait sync_view_wait : ",response.reqId);
            } else {
                console.error(`[‚ùå] No viewSQLConfig and  DATABASE view name in : ${response.view}`);
            }
        }
        else if (response.action === 'sync_pro_wait') {
            console.log(`[üîÑ] Syncing data for procedure : ${response.view}`);
            console.log(`[üîÑ] response.requestId : ${response.reqId}`);
            console.log(`[üîÑ] response.requestId : ${JSON.stringify(response.params)}`);
            const allprocedureNames = await fetchAllStoredProcedures();
            let data;
            if (allprocedureNames.includes(response.view)) {
                console.log(`[üìù] Found Procedure View for ${response.view}`);

                const viewConfig = viewsConfig.find(v => v.viewname === response.view);
                console.log(`[üìù] Found CODE Procedure View for ${viewConfig.cmd}`);
                data = await fetchProducerData(viewConfig.cmd,response.params); // ‚úÖ ‡πÉ‡∏ä‡πâ SQL query

                // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
                socket.send(JSON.stringify({
                    action: 'update_data_sql',
                    client_id: client_id,
                    view: response.view,
                    data,
                    requestId: response.reqId, // ‚úÖ ‡πÉ‡∏™‡πà requestId ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
                }));

                //console.log("sync_view_wait sync_view_wait sync_view_wait : ",response.reqId);
            } else {
                console.error(`[‚ùå] No viewSQLConfig and  DATABASE view name in : ${response.view}`);
            }
        }
        else if (response.action === 'sync_view_client_config') { //‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏•‡∏´‡∏î view ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏ô config ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á client
            console.log(`[üîÑ] Syncing data for view_P: ${response.view}`);
            const allViewNames = await fetchAllViewNames();
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ view ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `viewsConfig` ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const viewConfig = viewsConfig.find(v => v.viewname === response.view);
            let data;
            if (viewConfig && !allViewNames.includes(response.view)) {
                console.log(`[üìù] Found viewConfig for ${response.view}, using SQL query.`);
                const sqlQuery = loadSQLQuery(viewConfig);
                data = await fetchQueryData(sqlQuery); // ‚úÖ ‡πÉ‡∏ä‡πâ SQL query
                socket.send(JSON.stringify({
                    action: 'update_data_sql',
                    client_id: client_id,
                    view: response.view,
                    data,
                    requestId: response.requestId, // ‚úÖ ‡πÉ‡∏™‡πà requestId ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
                }));
            } else if (viewConfig === undefined && allViewNames.includes(response.view)) {
                console.log(`[üìù] Found Original View for ${response.view}`);
                data = await fetchViewData(response.view); // ‚úÖ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å View ‡∏õ‡∏Å‡∏ï‡∏¥
                // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server
                socket.send(JSON.stringify({
                    action: 'update_data_sql',
                    client_id: client_id,
                    view: response.view,
                    requestId: response.requestId, // ‚úÖ ‡πÉ‡∏™‡πà requestId ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
                    data
                }));
            } else {
                console.error(`[‚ùå] No viewSQLConfig and  DATABASE view name in : ${response.view}`);
            }
        } else if (response.action === 'sync_all') {
            console.log(`[üîÑ] Syncing all views`);

            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠ views ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const allViews = await fetchAllViewNames();
             console.log(`[üîÑ] allViews:`, allViews);

            //console.log(`[üîÑ] viewsConfig:`, viewsConfig);

            // ‚úÖ ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ viewsConfig ‡∏ó‡∏µ‡πà‡∏°‡∏µ run_on_startup: true
            const startupViews = viewsConfig.filter(v => v.run_on_startup);
            //console.log(`[üîÑ] startupViews after filtering:`, startupViews);

            // ‚úÖ ‡∏£‡∏ß‡∏° allViews ‡πÅ‡∏•‡∏∞ viewsConfig ‡∏ó‡∏µ‡πà‡∏°‡∏µ run_on_startup: true
            const viewsToSync = [
                ...allViews, // ‡πÄ‡∏û‡∏¥‡πà‡∏° views ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å allViews
                ...startupViews.filter(config => !allViews.includes(config.viewname)) // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ views ‡∏à‡∏≤‡∏Å viewsConfig ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô allViews
            ].map(view => (typeof view === 'object' ? view.viewname : view)); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠ view ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

            console.log(`[üîÑ] viewsToSync:`, viewsToSync);  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö views ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ sync

            // ‚úÖ ‡∏ñ‡πâ‡∏≤ viewsToSync ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (viewsToSync.length > 0) {
                // ‚úÖ ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ view ‡∏ó‡∏µ‡πà‡∏à‡∏∞ sync
                for (let view of viewsToSync) {
                    const viewConfig = viewsConfig.find(v => v.viewname === view);
                    let data;
                    //console.log(`[üîÑ] Syncing view: ${view} ${ JSON.stringify(viewConfig)}`);

                    if (viewConfig && viewConfig.sqlfile && viewConfig.run_on_startup ) {

                        console.log(`[üìù] Found viewConfig for ${view}, using SQL query.`);
                        const sqlQuery = loadSQLQuery(viewConfig);
                        data = await fetchQueryData(sqlQuery); // ‚úÖ ‡πÉ‡∏ä‡πâ SQL query
                    } else if (viewConfig  && viewConfig.run_on_startup &&  viewConfig.is_produce) {                    
                        data = await fetchProducerData(viewConfig.cmd,['','']); // ‚úÖ ‡πÉ‡∏ä‡πâ SQL query
                    } else{
                        //console.log(`[‚ö†Ô∏è] No SQL file or run_on_startup for ${view}, using default fetchViewData.`);
                        data = await fetchViewData(view); // ‚úÖ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å View ‡∏õ‡∏Å‡∏ï‡∏¥
                    }

                    // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Server ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ view
                    console.log(`[üîÑ] Sending data for ${view} to server.`);
                    socket.send(JSON.stringify({
                        action: 'update_data',
                        client_id: client_id,
                        view: view,
                        data
                    }));
                }
            } else {
                console.log(`[‚ö†Ô∏è] No views to sync. Please check the filters.`);
            }
        } else if (response.action === 'broadcast') {
            console.log(`[üîÑ] Broadcast Message From Server IS ${JSON.stringify(response.message)}`);
        } else if (response.action === 'run_sql') {

            console.log(`[üìù] Running custom SQL for view: ${response.view}`);
            if (!response.sql) {
                console.error(`[‚ùå] No SQL query provided for ${response.view}`);
                return;
            }

            try {   
                //console.log(`[‚úÖ] SQL codeyyyy , ${JSON.stringify(response.sql)}`);
                // üîÑ ‡πÅ‡∏õ‡∏•‡∏á `\"` ‡πÄ‡∏õ‡πá‡∏ô `"` ‡πÅ‡∏•‡∏∞ `\n` ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏•‡∏ö `\`
                //let sqlString = response.sql.replace(/\\"/g, '"').replace(/\\n/g, ' ').replace(/\\/g, '');

                //console.log(`[‚úÖ] SQL codexxxx , ${JSON.stringify(sqlString)}`);
                //console.log(`[‚úÖ] inclient req id , ${response.reqId}`);
                const result = await fetchQueryData(response.sql); // ‚úÖ ‡∏£‡∏±‡∏ô SQL query
                console.log(`[‚úÖ] SQL executed, ${result.length} records found and Send.`);

                //console.log(`[‚úÖ] SQL executed, ${JSON.stringify(result)}`);

                socket.send(JSON.stringify({
                    action: 'update_data_sql',
                    client_id: client_id,
                    view: response.view,
                    requestId: response.reqId, // ‚úÖ ‡πÉ‡∏™‡πà requestId ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà API ‡∏™‡πà‡∏á‡∏°‡∏≤
                    data: result

                }));

            } catch (error) {
                console.error(`[‚ùå] SQL execution failed: ${error.message}`);
            }
        }
    };

    socket.onerror = (error) => {
        console.error('[‚ùå] WebSocket error:', error);
        isConnecting = false;
    };

    socket.onclose = (event) => {
        console.log(`[‚ùå] WebSocket closed (Code: ${event.code}, Reason: ${event.reason || 'No reason'}). Reconnecting in 3s...`);
        isConnecting = false;
        setTimeout(() => loginUser(), 3000);
    };
}


async function loginUser() {
    if (isLoggingIn) {
        console.log('[‚ö†] Already logging in, skipping...');
        return;
    }
    isLoggingIn = true;

    try {
        const userCredential = await signInWithEmailAndPassword(auth, process.env.email, process.env.password);
        const user = userCredential.user;
        client_id = user.uid; // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö client_id
        const token = await user.getIdToken(true);
        console.log(`[üîë] Firebase Token: ${token.substring(0, 20)}...`);
        connectWebSocket(token);
    } catch (error) {
        console.error('[‚ùå] Login failed:', error);
    } finally {
        isLoggingIn = false;
    }
}

onAuthStateChanged(auth, (user) => {
    if (user && !isLoggedIn) {
        isLoggedIn = true;
        client_id = user.uid; // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö client_id
        user.getIdToken(true).then(token => connectWebSocket(token));
    } else {
        loginUser();
    }
});


loginUser();